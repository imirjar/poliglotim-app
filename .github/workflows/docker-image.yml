name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.7'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Build Web
      run: flutter build web --release --base-href /poliglotim-app/

    - name: Create archive
      run: |
        cd build/web
        zip -r poliglotim-app.zip .

    - name: Create Dockerfile for web app
      run: |
        cat > build/web/Dockerfile << EOF
        # Используем официальный nginx образ
        FROM nginx:alpine

        # Копируем собранное Flutter web приложение
        COPY . /usr/share/nginx/html

        # Настраиваем nginx для SPA приложения
        RUN echo 'server { \
            listen 80; \
            server_name _; \
            root /usr/share/nginx/html; \
            index index.html; \
            \
            location / { \
                try_files \\$uri \\$uri/ /index.html; \
            } \
            \
            # Кэширование статических ресурсов \
            location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { \
                expires 1y; \
                add_header Cache-Control "public, immutable"; \
            } \
        }' > /etc/nginx/conf.d/default.conf

        # Открываем порт 80
        EXPOSE 80

        CMD ["nginx", "-g", "daemon off;"]
        EOF

    - name: Build Docker image
      run: |
        cd build/web
        docker build -t poliglotim-app:latest -t poliglotim-app:${{ github.ref_name }} .

    - name: Save Docker image as artifact
      run: |
        cd build/web
        docker save poliglotim-app:latest -o poliglotim-app-docker.tar

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/web/poliglotim-app.zip
          build/web/poliglotim-app-docker.tar
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-push-docker:
    runs-on: ubuntu-latest
    needs: build-and-release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./artifacts

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./artifacts
        file: ./artifacts/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/poliglotim-app:latest
          ghcr.io/${{ github.repository }}/poliglotim-app:${{ github.ref_name }}